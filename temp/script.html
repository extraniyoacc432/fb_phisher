<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Supabase Browser Quickstart</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; }
      input, button, textarea { margin: 6px 0; display:block; }
      #messages { margin-top: 12px; }
      .msg { padding: 8px; border-bottom: 1px solid #eee; }
    </style>
  </head>
  <body>
    <h1>Supabase Browser Quickstart</h1>

    <section id="auth">
      <h2>Authentication</h2>
      <input id="email" placeholder="Email" />
      <input id="password" placeholder="Password" type="password" />
      <button id="signup">Sign up (email)</button>
      <button id="signin">Sign in (email)</button>
      <button id="signout">Sign out</button>
      <div id="sessionInfo"></div>
    </section>

    <section id="app" style="display:none;">
      <h2>Messages</h2>
      <textarea id="messageInput" placeholder="Write a message"></textarea>
      <button id="send">Send message</button>
      <button id="refresh">Refresh messages</button>
      <div id="messages"></div>
    </section>

    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

      // Initialize Supabase client
      const SUPABASE_URL = '<YOUR_SUPABASE_URL>';
      const SUPABASE_ANON_KEY = '<YOUR_SUPABASE_ANON_KEY>';
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // DOM refs
      const emailEl = document.getElementById('email');
      const passwordEl = document.getElementById('password');
      const signupBtn = document.getElementById('signup');
      const signinBtn = document.getElementById('signin');
      const signoutBtn = document.getElementById('signout');
      const sessionInfo = document.getElementById('sessionInfo');

      const appSection = document.getElementById('app');
      const msgInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('send');
      const refreshBtn = document.getElementById('refresh');
      const messagesDiv = document.getElementById('messages');

      // Helper: render session / UI
      async function updateUI() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
          sessionInfo.textContent = `Signed in as ${session.user.email || session.user.id}`;
          appSection.style.display = 'block';
        } else {
          sessionInfo.textContent = 'Not signed in';
          appSection.style.display = 'none';
        }
      }

      // Auth handlers
      signupBtn.addEventListener('click', async () => {
        const email = emailEl.value;
        const password = passwordEl.value;
        if (!email || !password) return alert('Provide email and password');
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) return alert('Sign up error: ' + error.message);
        alert('Sign up email sent (check your inbox).');
        updateUI();
      });

      signinBtn.addEventListener('click', async () => {
        const email = emailEl.value;
        const password = passwordEl.value;
        if (!email || !password) return alert('Provide email and password');
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) return alert('Sign in error: ' + error.message);
        updateUI();
        await loadMessages();
      });

      signoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        updateUI();
      });

      // Messages: assumes a table "messages" with columns (id uuid primary key default gen_random_uuid(), content text, inserted_at timestamptz default now())
      async function loadMessages() {
        const { data, error } = await supabase
          .from('messages')
          .select('id, content, inserted_at')
          .order('inserted_at', { ascending: false })
          .limit(50);
        if (error) {
          messagesDiv.innerHTML = 'Error loading messages: ' + error.message;
          return;
        }
        messagesDiv.innerHTML = '';
        data.forEach(m => {
          const el = document.createElement('div');
          el.className = 'msg';
          el.textContent = `${new Date(m.inserted_at).toLocaleString()} â€” ${m.content}`;
          messagesDiv.appendChild(el);
        });
      }

      sendBtn.addEventListener('click', async () => {
        const content = msgInput.value.trim();
        if (!content) return;
        const { data, error } = await supabase
          .from('messages')
          .insert([{ content }]);
        if (error) return alert('Insert error: ' + error.message);
        msgInput.value = '';
        await loadMessages();
      });

      refreshBtn.addEventListener('click', loadMessages);

      // Subscribe to auth changes (update UI)
      supabase.auth.onAuthStateChange((_event, _session) => {
        updateUI();
      });

      // Initial UI state
      updateUI();

      // Optional: fetch messages on load if signed in
      (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) await loadMessages();
      })();
    </script>
  </body>
</html>